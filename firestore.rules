rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // FIRESTORE SECURITY RULES
    // ============================================
    // These rules support two user types:
    // - Freelancer Dashboard: Manages clients, projects, payments
    // - Agency Dashboard: Manages clients, projects, payments, team members
    //
    // All dashboards use the same data structure with user_id ownership,
    // ensuring secure multi-tenant access control.
    // ============================================
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user owns the resource (for users collection)
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user owns the resource by user_id field
    // Works for: clients, projects, payments (all user types)
    function ownsResource() {
      return isAuthenticated() && resource.data.user_id == request.auth.uid;
    }
    
    // Check if user is creating resource with their own user_id
    // Works for: clients, projects, payments (all user types)
    function ownsNewResource() {
      return isAuthenticated() && request.resource.data.user_id == request.auth.uid;
    }
    
    // Validate user_id cannot be changed
    function userIdUnchanged() {
      return request.resource.data.user_id == resource.data.user_id;
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    
    match /users/{userId} {
      // Users can only read their own profile
      allow read: if isOwner(userId);
      
      // Users can create their own profile
      allow create: if isAuthenticated() && 
        request.auth.uid == userId &&
        request.resource.data.keys().hasAll(['id', 'name', 'email', 'plan', 'createdAt']) &&
        request.resource.data.id is string &&
        request.resource.data.name is string &&
        request.resource.data.email is string &&
        request.resource.data.plan in ['free', 'pro', 'agency'] &&
        request.resource.data.createdAt is timestamp;
      
      // Users can update their own profile
      allow update: if isOwner(userId) &&
        // Prevent changing user_id and immutable fields
        request.resource.data.id == resource.data.id &&
        // Allow plan changes (upgrade flow) - plan can be changed from free to pro/agency
        (request.resource.data.plan == resource.data.plan || 
         (resource.data.plan == 'free' && request.resource.data.plan in ['pro', 'agency'])) &&
        // Validate required fields
        request.resource.data.name is string &&
        request.resource.data.email is string &&
        request.resource.data.plan in ['free', 'pro', 'agency'] &&
        // Freelancer optional fields validation
        (!('phone' in request.resource.data) || request.resource.data.phone is string) &&
        (!('location' in request.resource.data) || request.resource.data.location is string) &&
        (!('bio' in request.resource.data) || request.resource.data.bio is string) &&
        // Agency optional fields validation
        (!('agencyName' in request.resource.data) || request.resource.data.agencyName is string) &&
        (!('agencyPhone' in request.resource.data) || request.resource.data.agencyPhone is string) &&
        (!('agencyEmail' in request.resource.data) || request.resource.data.agencyEmail is string) &&
        (!('agencyAddress' in request.resource.data) || request.resource.data.agencyAddress is string) &&
        (!('agencyWebsite' in request.resource.data) || request.resource.data.agencyWebsite is string) &&
        (!('agencyDescription' in request.resource.data) || request.resource.data.agencyDescription is string) &&
        (!('numberOfEmployees' in request.resource.data) || request.resource.data.numberOfEmployees is string) &&
        // System fields validation
        (!('profileComplete' in request.resource.data) || request.resource.data.profileComplete is bool) &&
        (!('feedback_given' in request.resource.data) || request.resource.data.feedback_given is bool) &&
        (!('userType' in request.resource.data) || request.resource.data.userType in ['freelancer', 'agency']);
      
      // Users can delete their own profile
      allow delete: if isOwner(userId);
    }
    
    // ============================================
    // CLIENTS COLLECTION
    // ============================================
    // Used by all three dashboard types:
    // - Freelancer: Their clients
    // - Agency: Their clients
    // ============================================
    
    match /clients/{clientId} {
      // Users can read their own clients (all user types)
      allow read: if isAuthenticated() && ownsResource();
      
      // Users can create clients with their own user_id
      allow create: if isAuthenticated() && ownsNewResource() &&
        // Validate required fields
        request.resource.data.user_id is string &&
        request.resource.data.name is string &&
        request.resource.data.createdAt is timestamp &&
        request.resource.data.updatedAt is timestamp &&
        // Validate optional fields
        (!('email' in request.resource.data) || request.resource.data.email is string) &&
        (!('phone' in request.resource.data) || request.resource.data.phone is string) &&
        (!('notes' in request.resource.data) || request.resource.data.notes is string);
      
      // Users can update their own clients
      allow update: if isAuthenticated() && ownsResource() &&
        // Prevent changing user_id
        userIdUnchanged() &&
        // Validate required fields
        request.resource.data.name is string &&
        request.resource.data.updatedAt is timestamp &&
        // Validate optional fields
        (!('email' in request.resource.data) || request.resource.data.email is string) &&
        (!('phone' in request.resource.data) || request.resource.data.phone is string) &&
        (!('notes' in request.resource.data) || request.resource.data.notes is string);
      
      // Users can delete their own clients
      allow delete: if isAuthenticated() && ownsResource();
    }
    
    // ============================================
    // PROJECTS COLLECTION
    // ============================================
    // Used by all three dashboard types:
    // - Freelancer: Their projects
    // - Agency: Their projects (can assign team_members)
    // ============================================
    
    match /projects/{projectId} {
      // Users can read their own projects (all user types)
      allow read: if isAuthenticated() && ownsResource();
      
      // Users can create projects with their own user_id
      allow create: if isAuthenticated() && ownsNewResource() &&
        // Validate required fields
        request.resource.data.user_id is string &&
        request.resource.data.client_id is string &&
        request.resource.data.name is string &&
        request.resource.data.status in ['active', 'completed', 'on-hold', 'cancelled'] &&
        request.resource.data.total_amount is number &&
        request.resource.data.total_amount >= 0 &&
        request.resource.data.total_amount <= 999999999 &&
        request.resource.data.createdAt is timestamp &&
        request.resource.data.updatedAt is timestamp &&
        // Validate optional fields
        (!('deadline' in request.resource.data) || request.resource.data.deadline is timestamp || request.resource.data.deadline == null) &&
        (!('reminder_date' in request.resource.data) || request.resource.data.reminder_date is timestamp || request.resource.data.reminder_date == null) &&
        (!('completed_date' in request.resource.data) || request.resource.data.completed_date is timestamp || request.resource.data.completed_date == null) &&
        // Validate team_members (for agencies, max 3)
        (!('team_members' in request.resource.data) || 
          request.resource.data.team_members == null ||
          (request.resource.data.team_members is list && 
           request.resource.data.team_members.size() <= 3 &&
           request.resource.data.team_members.size() >= 0));
      
      // Users can update their own projects
      allow update: if isAuthenticated() && ownsResource() &&
        // Prevent changing user_id and client_id
        userIdUnchanged() &&
        request.resource.data.client_id == resource.data.client_id &&
        // Validate required fields
        request.resource.data.name is string &&
        request.resource.data.status in ['active', 'completed', 'on-hold', 'cancelled'] &&
        request.resource.data.total_amount is number &&
        request.resource.data.total_amount >= 0 &&
        request.resource.data.total_amount <= 999999999 &&
        request.resource.data.updatedAt is timestamp &&
        // Validate optional fields
        (!('deadline' in request.resource.data) || request.resource.data.deadline is timestamp || request.resource.data.deadline == null) &&
        (!('reminder_date' in request.resource.data) || request.resource.data.reminder_date is timestamp || request.resource.data.reminder_date == null) &&
        (!('completed_date' in request.resource.data) || request.resource.data.completed_date is timestamp || request.resource.data.completed_date == null) &&
        // Validate team_members (for agencies, max 3)
        (!('team_members' in request.resource.data) || 
          request.resource.data.team_members == null ||
          (request.resource.data.team_members is list && 
           request.resource.data.team_members.size() <= 3 &&
           request.resource.data.team_members.size() >= 0));
      
      // Users can delete their own projects
      allow delete: if isAuthenticated() && ownsResource();
    }
    
    // ============================================
    // PAYMENTS COLLECTION
    // ============================================
    // Used by all three dashboard types:
    // - Freelancer: Payment tracking
    // - Agency: Payment tracking
    // ============================================
    
    match /payments/{paymentId} {
      // Users can read their own payments (all user types)
      allow read: if isAuthenticated() && ownsResource();
      
      // Users can create payments with their own user_id
      allow create: if isAuthenticated() && ownsNewResource() &&
        // Validate required fields
        request.resource.data.user_id is string &&
        request.resource.data.project_id is string &&
        request.resource.data.amount is number &&
        request.resource.data.amount > 0 &&
        request.resource.data.amount <= 999999999 &&
        request.resource.data.date is timestamp &&
        request.resource.data.createdAt is timestamp &&
        // Validate optional fields
        (!('notes' in request.resource.data) || request.resource.data.notes is string) &&
        (!('payment_type' in request.resource.data) || request.resource.data.payment_type in ['advance', 'partial', 'final'] || request.resource.data.payment_type == null);
      
      // Users can update their own payments
      allow update: if isAuthenticated() && ownsResource() &&
        // Prevent changing user_id and project_id
        userIdUnchanged() &&
        request.resource.data.project_id == resource.data.project_id &&
        // Prevent changing createdAt
        request.resource.data.createdAt == resource.data.createdAt &&
        // Validate required fields
        request.resource.data.amount is number &&
        request.resource.data.amount > 0 &&
        request.resource.data.amount <= 999999999 &&
        request.resource.data.date is timestamp &&
        // Validate optional fields
        (!('notes' in request.resource.data) || request.resource.data.notes is string) &&
        (!('payment_type' in request.resource.data) || request.resource.data.payment_type in ['advance', 'partial', 'final'] || request.resource.data.payment_type == null);
      
      // Users can delete their own payments
      allow delete: if isAuthenticated() && ownsResource();
    }
    
    // ============================================
    // TEAM MEMBERS COLLECTION
    // ============================================
    // Used ONLY by Agency Dashboard:
    // - Agencies can manage team members
    // - Team members can be assigned to projects (max 3 per project)
    // ============================================
    
    match /team_members/{memberId} {
      allow read: if isAuthenticated() && 
        resource.data.agency_id == request.auth.uid;
      
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.agency_id &&
        request.resource.data.keys().hasAll(['agency_id', 'name', 'email', 'role', 'createdAt', 'updatedAt']) &&
        request.resource.data.agency_id is string &&
        request.resource.data.name is string &&
        request.resource.data.email is string &&
        request.resource.data.role is string &&
        request.resource.data.createdAt is timestamp &&
        request.resource.data.updatedAt is timestamp;
      
      allow update: if isAuthenticated() &&
        resource.data.agency_id == request.auth.uid &&
        request.resource.data.agency_id == resource.data.agency_id &&
        request.resource.data.name is string &&
        request.resource.data.email is string &&
        request.resource.data.role is string &&
        request.resource.data.updatedAt is timestamp;
      
      allow delete: if isAuthenticated() &&
        resource.data.agency_id == request.auth.uid;
    }
    
    // ============================================
    // TEAM MEMBER PAYMENTS COLLECTION
    // ============================================
    // Used ONLY by Agency Dashboard:
    // - Agencies can track payments made to team members
    // - Payments can be linked to projects (optional)
    // ============================================
    
    match /team_member_payments/{paymentId} {
      // Agencies can read their own team member payments
      allow read: if isAuthenticated() && 
        resource.data.agency_id == request.auth.uid;
      
      // Agencies can create payments for their team members
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.agency_id &&
        // Validate required fields
        request.resource.data.agency_id is string &&
        request.resource.data.team_member_id is string &&
        request.resource.data.amount is number &&
        request.resource.data.amount > 0 &&
        request.resource.data.amount <= 999999999 &&
        request.resource.data.date is timestamp &&
        request.resource.data.createdAt is timestamp &&
        request.resource.data.updatedAt is timestamp &&
        // Validate optional fields
        (!('notes' in request.resource.data) || request.resource.data.notes is string || request.resource.data.notes == null) &&
        (!('project_id' in request.resource.data) || request.resource.data.project_id is string || request.resource.data.project_id == null);
      
      // Agencies can update their own payments (but not change agency_id or team_member_id)
      allow update: if isAuthenticated() &&
        resource.data.agency_id == request.auth.uid &&
        // Prevent changing agency_id and team_member_id
        request.resource.data.agency_id == resource.data.agency_id &&
        request.resource.data.team_member_id == resource.data.team_member_id &&
        // Prevent changing createdAt
        request.resource.data.createdAt == resource.data.createdAt &&
        // Validate required fields
        request.resource.data.amount is number &&
        request.resource.data.amount > 0 &&
        request.resource.data.amount <= 999999999 &&
        request.resource.data.date is timestamp &&
        request.resource.data.updatedAt is timestamp &&
        // Validate optional fields
        (!('notes' in request.resource.data) || request.resource.data.notes is string || request.resource.data.notes == null) &&
        (!('project_id' in request.resource.data) || request.resource.data.project_id is string || request.resource.data.project_id == null);
      
      // Agencies can delete their own payments
      allow delete: if isAuthenticated() &&
        resource.data.agency_id == request.auth.uid;
    }
    
    // ============================================
    // REVIEWS COLLECTION
    // ============================================
    // Used by all dashboard types:
    // - Users can submit reviews
    // - Public read for approved reviews (displayed on landing page)
    // ============================================
    
    match /reviews/{reviewId} {
      allow read: if true; // Public read for approved reviews
      allow create: if isAuthenticated() &&
        request.auth.uid == request.resource.data.user_id &&
        request.resource.data.keys().hasAll(['user_id', 'user_name', 'rating', 'comment', 'createdAt']) &&
        request.resource.data.user_id is string &&
        request.resource.data.user_name is string &&
        request.resource.data.rating is int &&
        request.resource.data.rating >= 1 &&
        request.resource.data.rating <= 5 &&
        request.resource.data.comment is string &&
        request.resource.data.createdAt is timestamp &&
        (!('features_requested' in request.resource.data) || request.resource.data.features_requested is string) &&
        (!('approved' in request.resource.data) || request.resource.data.approved is bool);
      allow update, delete: if false; // Only admins can update/delete (handled server-side)
    }
    
    // ============================================
    // DENY ALL OTHER COLLECTIONS
    // ============================================
    
    // Deny access to any other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

